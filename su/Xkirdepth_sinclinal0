#! /bin/sh
# shell for Kirchhoff depth migration

set -x

NAME="sinclinal"
FILE=$NAME".su"
FILEVEL=$NAME".vel"
FILEVELSU=$NAME".vel.su"
FILEVINT=$NAME".vint"

PAR=stkvel.$FILE
model='y'

nt=512
dt=0.004

#Define the size of velocity, traveltime and migration files
nz=200; nzt=$nz; nzo=$nz;
dz=10 ; dzt=$dz; dzo=$dz;
nx=300; nxt=$nx; nxo=$nx;
dx=10; dxt=$dx; dxo=$dz; # cdp spacing (given by the geometry)
fz=0; fzt=$fz;  fzo=$fz;
fx=0; fxt=$fx;  fxo=$fx;

velfilesize="nz=${nz} dz=${dz} fz=${fz} nx=${nx} dx=${dx} fx=${fx}"
traveltsize="fxt=${fxt} nxt=${nxt} dxt=${dxt} fzt=${fzt} nzt=${nzt} dzt=${dzt}"
migoutput="fxo=${fxo} nxo=${nxo} dxo=${dxo}  fzo=${fzo} nzo=${nzo} dzo=${dzo}"


labelz="Depth (m)"
labelx="Distance (m)"
ninf=0 npmax=201

# A grid is designed for the model
# Define an approximate velocity model in input

if [ $model = 'y' ]; then
unif2 < sinclinal.model method=spline x0=0.0,5000,0,5000 z0=0,0,2000,2000 v00=2000,2500 \
 $velfilesize > $FILEVINT 

unif2 < sinclinal.model method=spline x0=0.0,5000,0,5000 z0=0,0,2000,2000 v00=1,1 \
 $velfilesize > pvfile 

ximage < $FILEVINT  d1=$dz n1=$nz n2=$nx d2=$dx  cmap=hsv1 legend=1 label1="$labelz" label2="$labelx" title="Velocity"  style=seismic  units=vel  &

fi
# Ray tracing is performed in the velocity model  
# The parameters nx, nz, dx, dz, etc refers to the input velocity model
# The parameters nxo, nzo, dxo, dzo, etc refers to the output traveltime tables
# The parameters nxs, dxs,  etc refers to the shots
# The parameters na, da,  etc refers to the rays (angles)

# For this example we set the traveltimes parameters equal to the input velocty model

fxs=0  nxs=60 dxs=50
fa=-75 na=76 da=2 amax=75

if [ 1 -eq 1 ]; then
# Use this
rayt2dmod < $FILEVINT $traveltsize dt=$dt nt=$nt \
fxs=$fxs nxs=$nxs dxs=$dxs  $velfilesize aperx=2000 \
fa=-60 na=61 da=2 amax=75 fac=0.01 ms=10 ek=1 npv=1 jpfile=jpfile.ray tfile=tfile \
pvfile=pvfile csfile=csfile

elif [ 0 -eq 1 ]; then

rayt2d < $FILEVINT dt=$dt   nt=$nt fz=0 nz=$nz dz=$dz fx=$fx nx=$nx dx=$dx \
	fxo=$fx nxo=$nx dxo=$dx fzo=$fz nzo=$nz dzo=$dz fxs=$fxs nxs=$nxs dxs=$dxs  \
	aperx=2500 fa=$fa na=$na da=$da amax=$amax fac=0.01 ms=10 ek=1 npv=0 \
	jpfile=jpfile.ray tfile=tfile 

fi


pscube< tfile  n1=$nz d1=$dz f1=$fz n2=$nx d2=$dx f2=0 n3=$nxs d3=$dxs \
	label1="Depth (m)" label2="Midpoint (m)"  label3="Shots (m)"  \
	ybox=3 hbox=4 \
	bclip=2 d1num=500 d2num=1000 d3num=500  brgb=1,0,0 \
	title="Traveltime Tables"  legend=0 > time.eps

gv time.eps &

# shell for Kirchhoff depth migration
# Kirchhoff requires the traveltimes generated by ray tracing
# the traveltime parameters used in the ray tracing code are required
# First line contain traveltime table par 

# Generate output image gathers  
off0=100 noff=60 doff=40
# Generate zero offset output image only  
off0=0 noff=1 doff=40

sukdmig2d  $traveltsize fs=$fxs ns=$nxs ds=$nxs \
$migoutput \
aperx=2000 dxm=1 ntr=20200 ls=0 ttfile=tfile  \
off0=$off0 noff=$noff doff=$doff  \
< $FILE  > $NAME".kmig.su"  

# Plotting migrated data

suximage<  $NAME".kmig.su"  perc=99.5 legend=1 units=amp cmap=hsv5 \
	label1="Depth (km)" label2="Midpoint (km)" \
	title="Kirchhoff Depth Migration" \
	wbox=$WIDTH hbox=$HEIGHT xbox=$WIDTHOFF3 ybox=$HEIGHTOFF1 &


exit 0






