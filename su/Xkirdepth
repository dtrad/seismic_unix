#! /bin/sh
# shell for Kirchhoff depth migration

set -x
# A grid is designed for the model
nz=51 dz=50 fz=.0  labelz="Depth (m)"
nx=71 dx=50 fx=0.0  labelx="Distance (m)"
ninf=0 npmax=201 
dt=0.004  nt=501 

# Define an approximate velocity model in input

unif2 <input >vfile  ninf=$ninf  npmax=$npmax \
	nz=$nz dz=$dz fz=$fz nx=$nx dx=$dx fx=$fx \
	v00=1500  dvdz=0.8

ximage <vfile  style=seismic legend=1 units=vel cmap=hsv5 \
	n1=$nz d1=$dz f1=$fz grid1=dot label1="$labelz" \
	n2=$nx d2=$dx f2=$fx grid2=dot label2="$labelx" \
	title="Velocity"  & 

# Ray tracing is performed in the velocity model  
# The parameters nx, nz, dx, dz, etc refers to the input velocity model
# The parameters nxo, nzo, dxo, dzo, etc refers to the output traveltime tables
# The parameters nxs, dxs,  etc refers to the shots
# The parameters na, da,  etc refers to the rays (angles)

# For this example we set the traveltimes parameters equal to the input velocty model

fxs=0  nxs=36 dxs=100
fa=-75 na=76 da=2 amax=75

rayt2d <vfile dt=$dt   nt=$nt fz=0 nz=$nz dz=$dz fx=$fx nx=$nx dx=$dx \
	fxo=$fx nxo=$nx dxo=$dx fzo=$fz nzo=$nz dzo=$dz fxs=$fs nxs=$nxs dxs=$dxs  \
	aperx=2500 fa=$fa na=$na da=$da amax=$amax fac=0.01 ms=10 ek=1 npv=0 \
	jpfile=jpfile.ray tfile=tfile

# What is f2, 

pscube<tfile n1=$nz d1=$dz f1=$fz n2=$nx d2=$dx f2=500 n3=$nxs d3=$dxs \
	label1="Depth (m)" label2="Midpoint (m)" \
	ybox=3 hbox=4 \
	bclip=2 d1num=500 d2num=1000 \
	title="Traveltime Tables"  > time.eps

gv time.eps &

# Kirchhoff modeling for linear v(x,z)
# data details (seismic geometry and model ) 
nt=725 dt=$dt ft=0.0 tmin=0.2 
nxs=6 dxs=0.3 fxs=0.05 
fxo=0.1 dxo=0.025 nxo=60
fpeak=30 er=0 ls=1 

susynlv  nt=$nt dt=$dt ft=$ft nxs=$nxs dxs=$dxs fxs=$fxs  fxo=$fxo\
dxo=$dxo nxo=$nxo tmin=$tmin v00=1.5 dvdx=0.0 dvdz=0.8 \
fpeak=$fpeak er=1 ls=1 \
ref="1:0,0.5;1,1.5;2.,1.5,3,0.5" >data

# shell for plotting synthetic data and migrated data
suximage<data  perc=99.5 legend=1 units=amp cmap=hsv5 \
	label1="Time (s)" label2="Midpoint (m)" \
	title="Synthetic Data" \
	wbox=$WIDTH hbox=$HEIGHT xbox=$WIDTHOFF2 ybox=$HEIGHTOFF1 &


# shell for Kirchhoff depth migration
# Kirchhoff requires the traveltimes generated by ray tracing
# the traveltime parameters used in the ray tracing code are required

sukdmig2d  fzt=$fz nzt=$nz dzt=$dz fxt=$fx nxt=$nx dxt=$dx fs=0 ns=36 ds=100 \
fxo=0 nxo=141 dxo=25 \
fzo=0 nzo=251 dzo=10 \
aperx=2000 dxm=12.5 ntr=1000 ls=1 \
off0=0 noff=1 doff=200 \
v0=1500 dvz=0.0  \
offmax=4000 angmax=60 fmax=55 \
jpfile=jpfile.kd \
ttfile=tfile \
< data  > kd.data 

# Plotting migrated data

suximage<kd.data perc=99.5 legend=1 units=amp cmap=hsv5 \
	label1="Depth (km)" label2="Midpoint (km)" \
	title="Kirchhoff Depth Migration" \
	wbox=$WIDTH hbox=$HEIGHT xbox=$WIDTHOFF3 ybox=$HEIGHTOFF1 &

exit 0 