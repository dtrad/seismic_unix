#! /bin/sh
# shell for Kirchhoff depth migration

set -x

NAME="sinclinal"
FILE=$NAME".su"
FILEVEL=$NAME".vel"
FILEVELSU=$NAME".vel.su"
FILEVINT=$NAME".vint"

PAR=stkvel.$FILE
model='y'

nt=512
dt=0.004
nz=200
dz=10 
nx=300
dx=10 # cdp spacing (given by the geometry)
fz=0  
fx=0
labelz="Depth (m)"
labelx="Distance (m)"
ninf=0 npmax=201

# A grid is designed for the model
# Define an approximate velocity model in input

if [ $model = 'y' ]; then
unif2 < sinclinal.model method=spline x0=0.0,5000,0,5000 z0=0,0,2000,2000 v00=2000,2500 \
 nx=$nx nz=$nz dx=$dx dz=$dz > $FILEVINT 

ximage < $FILEVINT  d1=$dz n1=$nz n2=$nx d2=$dx  cmap=hsv1 legend=1 label1="$labelz" label2="$labelx" title="Velocity"  style=seismic  units=vel  &

fi
# Ray tracing is performed in the velocity model  
# The parameters nx, nz, dx, dz, etc refers to the input velocity model
# The parameters nxo, nzo, dxo, dzo, etc refers to the output traveltime tables
# The parameters nxs, dxs,  etc refers to the shots
# The parameters na, da,  etc refers to the rays (angles)

# For this example we set the traveltimes parameters equal to the input velocty model

fxs=0  nxs=60 dxs=50
fa=-75 na=76 da=2 amax=75

rayt2d < $FILEVINT dt=$dt   nt=$nt fz=0 nz=$nz dz=$dz fx=$fx nx=$nx dx=$dx \
	fxo=$fx nxo=$nx dxo=$dx fzo=$fz nzo=$nz dzo=$dz fxs=$fxs nxs=$nxs dxs=$dxs  \
	aperx=2500 fa=$fa na=$na da=$da amax=$amax fac=0.01 ms=10 ek=1 npv=0 \
	jpfile=jpfile.ray tfile=tfile



pscube< tfile  n1=$nz d1=$dz f1=$fz n2=$nx d2=$dx f2=0 n3=$nxs d3=$dxs \
	label1="Depth (m)" label2="Midpoint (m)"  label3="Shots (m)"  \
	ybox=3 hbox=4 \
	bclip=2 d1num=500 d2num=1000 d3num=500  brgb=1,0,0 \
	title="Traveltime Tables"  legend=0 > time.eps

gv time.eps &
#exit 0
# shell for Kirchhoff depth migration
# Kirchhoff requires the traveltimes generated by ray tracing
# the traveltime parameters used in the ray tracing code are required
# First line contain traveltime table par 

veloc="noff=60 doff=40"
sukdmig2d  fxt=$fx fzt=$fz nzt=$nz dzt=$dz nxt=$nx dxt=$dx fs=$fxs ns=$nxs ds=$nxs \
fxo=0 nxo=$nx dxo=$dx \
fzo=0 nzo=$nz dzo=$dz \
aperx=2000 dxm=1 ntr=20200 ls=0 ttfile=tfile $veloc \
< $FILE  > $NAME".kmig.su" 

# Plotting migrated data

suximage<  $NAME".kmig.su"  perc=99.5 legend=1 units=amp cmap=hsv5 \
	label1="Depth (km)" label2="Midpoint (km)" \
	title="Kirchhoff Depth Migration" \
	wbox=$WIDTH hbox=$HEIGHT xbox=$WIDTHOFF3 ybox=$HEIGHTOFF1 &


exit 0

# Kirchhoff modeling for linear v(x,z)
# data details (seismic geometry and model ) 
nt=725 dt=$dt ft=0.0 tmin=0.2 
nxs=6 dxs=0.3 fxs=0.05 
fxo=0.1 dxo=0.025 nxo=60
fpeak=30 er=0 ls=1 

susynlv  nt=$nt dt=$dt ft=$ft nxs=$nxs dxs=$dxs fxs=$fxs  fxo=$fxo\
dxo=$dxo nxo=$nxo tmin=$tmin v00=1.5 dvdx=0.0 dvdz=0.8 \
fpeak=$fpeak er=1 ls=1 \
ref="1:0,0.5;1,1.5;2.,1.5,3,0.5" >data

# shell for plotting synthetic data and migrated data
suximage<data  perc=99.5 legend=1 units=amp cmap=hsv5 \
	label1="Time (s)" label2="Midpoint (m)" \
	title="Synthetic Data" \
	wbox=$WIDTH hbox=$HEIGHT xbox=$WIDTHOFF2 ybox=$HEIGHTOFF1 &



exit 0 


# Tentative construction of velocity model from stacking velocities
# 
# Given the parfile (from Velan0) compute the velocity file
sureadveli par=$PAR > $FILEVELSU cdpmin=501 cdpmax=2500 verbose=1 dxcdp=10 

suximage key=cdp < $FILEVELSU title=$FILEVELSU cmap=hsv1 legend=1 &


# Obtain the velocity file for ray tracing

sustrip < $FILEVELSU > $FILEVEL

velconv intype=vrmst outtype=vintz < $FILEVEL > $FILEVINT nt=$nt dt=$dt nz=$nz dz=$dz nx=$nx  

ximage < $FILEVINT  d1=$dz n1=$nz n2=$nx d2=$dx  cmap=hsv1 legend=1 



exit 0
